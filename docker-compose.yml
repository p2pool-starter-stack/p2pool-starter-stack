x-logging: &default-logging
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "3"

services:
  # --- Tor Anonymity Service ---
  # Orchestrates Tor Hidden Services (Onion addresses) for Monero, Tari, and P2Pool.
  # Assigned a static IP (172.28.0.25) to function as the centralized SOCKS5 gateway for the stack.
  tor:
    build: ./build/tor
    container_name: tor
    restart: unless-stopped
    logging: *default-logging
    volumes:
      - ${TOR_DATA_DIR}:/var/lib/tor
    expose:
      - "9050" # SOCKS5 Proxy
      - "9051" # Control Port
    networks:
      mining_net:
        ipv4_address: 172.28.0.25
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "9050"]
      interval: 10s
      timeout: 5s
      retries: 5

  # --- Monero Daemon (monerod) ---
  # The primary Monero Full Node. Configured to route transaction broadcasts via Tor (tx-proxy) for privacy.
  # Exposes P2P and RPC interfaces solely to the internal Docker network.
  monerod:
    build: ./build/monero
    container_name: monerod
    restart: unless-stopped
    stop_grace_period: 1m
    logging: *default-logging
    environment:
      - MONERO_NODE_USERNAME=${MONERO_NODE_USERNAME}
      - MONERO_NODE_PASSWORD=${MONERO_NODE_PASSWORD}
      - MONERO_ONION_ADDRESS=${MONERO_ONION_ADDRESS}
      - MONERO_PRUNE=${MONERO_PRUNE}
    volumes:
      - ${MONERO_DATA_DIR}:/root/.bitmonero
      - /dev/hugepages:/dev/hugepages # Required for RandomX verification performance
      - ./build/monero/bitmonero.conf.template:/root/bitmonero.conf.template:ro
    ports:
      - "18080:18080" # P2P (Public)
      - "18081:18081" # RPC (Restricted)
      - "18083:18083" # ZMQ (P2Pool)
    networks:
      mining_net:
        ipv4_address: 172.28.0.26
    depends_on:
      tor:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "--digest", "-u", "${MONERO_NODE_USERNAME}:${MONERO_NODE_PASSWORD}", "http://localhost:18081/get_info"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 60s

  # --- Tari Base Node ---
  # Minotari Base Node for merge mining. Configured to utilize Tor for all peer-to-peer communication.
  tari:
    image: quay.io/tarilabs/minotari_node:v5.2.1-mainnet
    container_name: tari
    restart: unless-stopped
    stop_grace_period: 1m
    logging: *default-logging
    dns:
      - 1.1.1.1
      - 8.8.8.8
    dns_search: .
    dns_opt:
      - use-vc
    environment:
      - WAIT_FOR_TOR=1
    volumes:
      - ${TARI_DATA_DIR}:/var/tari/node
      - ./build/tari:/var/tari/config
    ports:
      - "18102:18102" # Wallet GRPC
      - "18142:18142" # Base Node GRPC
    command:
      - --disable-splash-screen
      - --non-interactive
    networks:
      mining_net:
        ipv4_address: 172.28.0.27
    depends_on:
      tor:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "ps | grep minotari_node || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s

  # --- P2Pool Node ---
  # Decentralized mining sidechain node.
  # Acts as the coordinator between the Monero daemon, Tari Base Node, and downstream miners.
  p2pool:
    build: ./build/p2pool
    container_name: p2pool
    restart: unless-stopped
    logging: *default-logging
    privileged: true # Required for efficient memory access (HugePages)
    volumes:
      - ${P2POOL_DATA_DIR}:/root
      - ${P2POOL_DATA_DIR}/stats:/stats # Shared volume for Dashboard
      - /dev/hugepages:/dev/hugepages
    ports:
      - "3334:3334"   # Local API
      - "${P2POOL_PORT}:${P2POOL_PORT}" # P2P Sidechain Port
    command:
      - --host
      - 172.28.0.26
      - --rpc-port
      - "18081"
      - --rpc-login
      - "${MONERO_NODE_USERNAME}:${MONERO_NODE_PASSWORD}"
      - --zmq-port
      - "18083"
      - --wallet
      - ${MONERO_WALLET_ADDRESS} 
      - --merge-mine
      - tari://172.28.0.27:18142
      - ${TARI_WALLET_ADDRESS}
      - --onion-address
      - ${P2POOL_ONION_ADDRESS} 
      - --local-api
      - --stratum
      - 0.0.0.0:3333
      - --p2p
      - 0.0.0.0:${P2POOL_PORT}
      - --data-api
      - /stats
      - ${P2POOL_FLAGS}
    networks:
      mining_net:
        ipv4_address: 172.28.0.28
    depends_on:
      monerod:
        condition: service_healthy
      tari:
        condition: service_healthy

  # --- XMRig Proxy ---
  # Connection aggregator for the XMRvsBeast donation/bonus pool.
  # Reduces upstream connection overhead and manages hashrate routing.
  xmrig-proxy:
    build: ./build/xmrig-proxy
    container_name: xmrig-proxy
    restart: unless-stopped
    logging: *default-logging
    ports:
      - "3333:3333"
      - "${PROXY_API_PORT}:${PROXY_API_PORT}" # API Port
    environment:
      - PROXY_API_PORT=${PROXY_API_PORT}
      - PROXY_AUTH_TOKEN=${PROXY_AUTH_TOKEN}
    command:
      - -o
      - ${P2POOL_URL}
      - -u
      - ${MONERO_WALLET_ADDRESS}
      - -b
      - 0.0.0.0:3333
      - -m
      - simple
      - --coin
      - monero
      - --verbose
      - --http-host
      - 0.0.0.0
      - --http-port
      - ${PROXY_API_PORT}
      - --http-access-token
      - ${PROXY_AUTH_TOKEN}
      - --http-no-restricted
    networks:
      mining_net:
        ipv4_address: 172.28.0.29
    depends_on:
      - p2pool

  # --- Monitoring Dashboard ---
  # Web-based management interface and visualization engine.
  # Utilizes host networking mode to facilitate mDNS/Avahi discovery of local mining workers.
  dashboard:
      build: ./build/dashboard
      extra_hosts:
        - "host.docker.internal:host-gateway"
      container_name: dashboard
      restart: unless-stopped
      logging: *default-logging
      network_mode: "host" # Critical for mDNS/Avahi discovery
      volumes:
        - ${P2POOL_DATA_DIR}/stats:/app/stats:ro # Read-only access to P2Pool stats
        - ${DASHBOARD_DATA_DIR}:/data
        - /var/run/dbus:/var/run/dbus:ro
        - /var/run/avahi-daemon/socket:/var/run/avahi-daemon/socket
      environment:
      - HOST_IP=${HOST_IP:-127.0.0.1}
      - TZ=America/Chicago
      - P2POOL_URL=${P2POOL_URL}
      - MONERO_WALLET_ADDRESS=${MONERO_WALLET_ADDRESS}
      - XVB_ENABLED=${XVB_ENABLED}
      - XVB_POOL_URL=${XVB_POOL_URL}
      - XVB_DONOR_ID=${XVB_DONOR_ID}
      - PROXY_HOST=172.28.0.29
      - PROXY_API_PORT=${PROXY_API_PORT}
      - PROXY_AUTH_TOKEN=${PROXY_AUTH_TOKEN}
      - DOCKER_PROXY_URL=tcp://172.28.0.30:2375

  # --- Docker Socket Proxy ---
  # Secure, read-only proxy for the Docker Socket.
  # Allows the Dashboard to safely query container logs and stats without exposing the full socket.
  docker-proxy:
    image: tecnativa/docker-socket-proxy
    container_name: docker-proxy
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro # Read-only mount
    environment:
      - CONTAINERS=1 # Allow listing containers
      - LOGS=1       # Allow reading logs
    networks:
      mining_net:
        ipv4_address: 172.28.0.30

# --- Network Configuration ---
# Defines a static bridge network to ensure predictable IP assignment for Tor gateway routing.
networks:
  mining_net:
    driver: bridge
    name: mining_net
    ipam:
      config:
        - subnet: 172.28.0.0/24