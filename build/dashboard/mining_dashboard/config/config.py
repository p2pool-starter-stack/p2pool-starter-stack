import os
import json

# --- System Configuration & Paths ---
# Base directory for statistics generated by the P2Pool sidecar
BASE_STATS_DIR = "/app/stats"

# Persistent storage path for application state
DISK_PATH = '/data'
DB_FILE_PATH = os.path.join(DISK_PATH, "mining_data.db")

# --- Data Source File Paths ---
# Specific JSON endpoints for various mining metrics
STRATUM_STATS_PATH = f"{BASE_STATS_DIR}/local/stratum"
TARI_STATS_PATH = f"{BASE_STATS_DIR}/local/merge_mining"
P2P_STATS_PATH = f"{BASE_STATS_DIR}/local/p2p"
POOL_STATS_PATH = f"{BASE_STATS_DIR}/pool/stats"
NETWORK_STATS_PATH = f"{BASE_STATS_DIR}/network/stats"

# --- Network & API Configuration ---
# Host IP for dashboard display purposes
HOST_IP = os.environ.get("HOST_IP", "Unknown Host")

# XMRig API settings
XMRIG_API_PORT = 8080
API_TIMEOUT = 1         # Connection timeout in seconds
UPDATE_INTERVAL = 30    # Main data collection loop interval in seconds

# --- XvB Algorithm Constants ---
# Cycle length for the donation switching algorithm (60 seconds)
XVB_TIME_ALGO_MS = 60000        

# Minimum duration to stay on a pool to ensure share submission (15 seconds)
XVB_MIN_TIME_SEND_MS = 15000    

# Wallet address required for fetching XvB bonus history
MONERO_WALLET_ADDRESS = os.environ.get("MONERO_WALLET_ADDRESS", "") 

# Donor ID for XMRvsBeast pool
XVB_DONOR_ID = os.environ.get("XVB_DONOR_ID", "")

# Feature Flag: Enable/Disable XvB switching logic
ENABLE_XVB = os.environ.get("XVB_ENABLED", "true").lower() == "true"

# --- Upstream Pool Configuration ---
P2POOL_URL = os.environ.get("P2POOL_URL", "")
XVB_POOL_URL = os.environ.get("XVB_POOL_URL", "")

# --- Proxy API Configuration ---
PROXY_AUTH_TOKEN = os.environ.get("PROXY_AUTH_TOKEN", "")
PROXY_HOST = os.environ.get("PROXY_HOST", "127.0.0.1")
PROXY_API_PORT = int(os.environ.get("PROXY_API_PORT", 3344))

# --- Algorithm Safety Margins ---
# Safety margin (5%) to ensure the 1h average strictly meets the tier requirement
ALGO_MARGIN_1H = 0.05

# --- Data Retention Policies ---
HISTORY_RETENTION_SEC = 30 * 24 * 3600  # 30 Days
WORKER_RETENTION_SEC = 7 * 24 * 3600    # 7 Days

# --- Donation Tier Configuration ---
# Hashrate thresholds (H/s) for XMRvsBeast donation tiers.
# Source: Official XvB rules (Mega=1M, Whale=100k, VIP=10k, Donor=1k)
TIER_DEFAULTS = {
    "donor_mega": 1_000_000, 
    "donor_whale": 100_000, 
    "donor_vip": 10_000,    
    "donor": 1_000          
}

# Allow configuration override via environment variable (injected by deploy.sh)
env_tiers = os.environ.get("TIER_CONFIG")
if env_tiers and env_tiers.strip() and env_tiers != "''":
    try:
        custom_tiers = json.loads(env_tiers.strip("'"))
        if isinstance(custom_tiers, dict):
            TIER_DEFAULTS = custom_tiers
    except json.JSONDecodeError:
        pass

# --- P2Pool Protocol Constants ---
# Parameters for PPLNS (Pay Per Last N Shares) window calculation
BLOCK_PPLNS_WINDOW_MAIN = 2160  # Window size in blocks
BLOCK_PPLNS_WINDOW_MINI = 2160
BLOCK_PPLNS_WINDOW_NANO = 2160

SECOND_PER_BLOCK_MAIN = 120          # Monero Target block time in seconds
SECOND_PER_BLOCK_P2POOL_MAIN = 10    # P2Pool Main Block Time
SECOND_PER_BLOCK_P2POOL_MINI = 10    # P2Pool Mini Block Time
SECOND_PER_BLOCK_P2POOL_NANO = 30    # P2Pool Nano Block Time